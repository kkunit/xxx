import React, { useState, useEffect } from 'react';
import { initializeApp } from 'firebase/app';
import { 
  getAuth, 
  signInAnonymously, 
  onAuthStateChanged,
  signInWithCustomToken
} from 'firebase/auth';
import { 
  getFirestore, 
  collection, 
  addDoc, 
  onSnapshot, 
  query,
  orderBy
} from 'firebase/firestore';
import { 
  Heart, 
  Send, 
  Lock, 
  Mail, 
  Sparkles, 
  Candy, 
  Unlock,
  Share2,
  Info
} from 'lucide-react';

// --- Firebase Initialization ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

export default function SugarMailbox() {
  const [user, setUser] = useState(null);
  const [view, setView] = useState('write'); // 'write' or 'read'
  const [messages, setMessages] = useState([]);
  const [loading, setLoading] = useState(false);
  
  // Form State
  const [senderName, setSenderName] = useState('');
  const [messageContent, setMessageContent] = useState('');
  const [showSuccess, setShowSuccess] = useState(false);

  // Admin State
  const [adminCode, setAdminCode] = useState('');
  const [isUnlocked, setIsUnlocked] = useState(false);
  const [showShareHelp, setShowShareHelp] = useState(false);
  
  const SECRET_CODE = "520"; 

  // 1. Auth Setup
  useEffect(() => {
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (error) {
        console.error("Auth error:", error);
      }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, setUser);
    return () => unsubscribe();
  }, []);

  // 2. Data Fetching
  useEffect(() => {
    if (!user || view !== 'read' || !isUnlocked) return;

    // Use simple query, sort in memory to avoid index errors
    const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'sugar_messages'));
    
    const unsubscribe = onSnapshot(q, (snapshot) => {
      const msgs = snapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data()
      }));
      // Sort descending by timestamp
      msgs.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
      setMessages(msgs);
    }, (error) => {
      console.error("Error fetching messages:", error);
    });

    return () => unsubscribe();
  }, [user, view, isUnlocked]);

  // 3. Send Message
  const handleSend = async (e) => {
    e.preventDefault(); // Crucial: prevent page reload
    if (!messageContent.trim()) return;
    if (!user) return;

    setLoading(true);
    try {
      await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'sugar_messages'), {
        name: senderName.trim() || 'åŒ¿åå°å¯çˆ±',
        content: messageContent,
        timestamp: Date.now(),
        theme: Math.floor(Math.random() * 3)
      });
      
      setShowSuccess(true);
      setSenderName('');
      setMessageContent('');
      setTimeout(() => setShowSuccess(false), 3000);
    } catch (error) {
      console.error("Error sending message:", error);
      // Fallback for demo if auth fails
      alert("å‘é€é‡åˆ°äº†ä¸€ç‚¹å°é—®é¢˜ï¼Œè¯·åˆ·æ–°åå†è¯•~");
    } finally {
      setLoading(false);
    }
  };

  // 4. Unlock Logic
  const handleUnlock = (e) => {
    e.preventDefault(); // Crucial: prevent page reload
    if (adminCode === SECRET_CODE) {
      setIsUnlocked(true);
      setAdminCode('');
    } else {
      alert("æš—å·ä¸å¯¹å“¦ï¼");
    }
  };

  // --- UI Styles ---
  const bgStyle = {
    backgroundImage: `radial-gradient(#fbcfe8 1px, transparent 1px), radial-gradient(#fbcfe8 1px, transparent 1px)`,
    backgroundSize: '20px 20px',
    backgroundPosition: '0 0, 10px 10px',
    backgroundColor: '#fff1f2' 
  };

  return (
    <div style={bgStyle} className="min-h-screen w-full flex flex-col items-center font-sans text-slate-700 relative overflow-hidden selection:bg-pink-200">
      
      {/* Share Help Modal */}
      {showShareHelp && (
        <div className="fixed inset-0 bg-black/50 z-[60] flex items-center justify-center p-4 backdrop-blur-sm" onClick={() => setShowShareHelp(false)}>
          <div className="bg-white rounded-3xl p-6 max-w-sm w-full shadow-2xl border-4 border-pink-200 animate-bounce-in" onClick={e => e.stopPropagation()}>
            <h3 className="text-xl font-bold text-pink-600 mb-3 flex items-center gap-2">
              <Info size={24} /> å¦‚ä½•å‘ç»™æœ‹å‹ï¼Ÿ
            </h3>
            <div className="space-y-3 text-sm text-gray-600 leading-relaxed">
              <p>
                <span className="font-bold text-gray-800">å¦‚æœä½ ç›´æ¥å¤åˆ¶ç°åœ¨çš„æµè§ˆå™¨é“¾æ¥ï¼š</span><br/>
                æœ‹å‹æ‰“å¼€ä¼šè·³è½¬åˆ°ç™»å½•é¡µï¼Œæˆ–è€…æ‰“ä¸å¼€ï¼Œå› ä¸ºè¿™æ˜¯ä½ çš„<span className="text-red-500 font-bold">ç§å¯†é¢„è§ˆç‰ˆ</span>ã€‚
              </p>
              <hr className="border-dashed border-pink-200"/>
              <p>
                <span className="font-bold text-gray-800">æ­£ç¡®åšæ³•ï¼š</span><br/>
                ä½ éœ€è¦ç‚¹å‡»ç¼–è¾‘å™¨å³ä¸Šè§’çš„ <span className="bg-gray-200 px-1 rounded text-xs font-mono">Publish</span> æˆ– <span className="bg-gray-200 px-1 rounded text-xs font-mono">Deploy</span> æŒ‰é’®ï¼ˆå¦‚æœæœ‰ï¼‰ï¼Œæˆ–è€…å°†ä»£ç å¤åˆ¶åˆ° Vercel/Netlify ç­‰å¹³å°è¿›è¡Œå‘å¸ƒã€‚
              </p>
              <p className="bg-pink-50 p-2 rounded-lg text-pink-700 text-xs">
                æç¤ºï¼šå‘å¸ƒåä½ ä¼šè·å¾—ä¸€ä¸ªç±»ä¼¼ `myapp.vercel.app` çš„æ­£å¼ç½‘å€ï¼Œé‚£ä¸ªç½‘å€æ‰æ˜¯å¯ä»¥åˆ†äº«ç»™ä»»ä½•äººçš„å“¦ï¼
              </p>
            </div>
            <button 
              onClick={() => setShowShareHelp(false)}
              className="w-full mt-5 bg-pink-500 text-white py-3 rounded-xl font-bold shadow-md hover:bg-pink-600 transition-colors"
            >
              æˆ‘æ˜ç™½å•¦
            </button>
          </div>
        </div>
      )}

      {/* Decorative Background Elements */}
      <div className="absolute top-10 left-10 text-pink-200 animate-bounce delay-700 select-none pointer-events-none">
        <Heart size={40} fill="currentColor" />
      </div>
      <div className="absolute bottom-20 right-10 text-purple-200 animate-pulse select-none pointer-events-none">
        <Candy size={50} />
      </div>

      {/* Header */}
      <header className="w-full max-w-3xl p-4 md:p-6 flex justify-between items-center z-10">
        <div className="flex items-center gap-2 bg-white/80 backdrop-blur-sm px-4 py-2 rounded-full shadow-sm border border-pink-100">
          <Mail className="text-pink-500" size={20} />
          <span className="font-bold text-pink-600 tracking-wider">ç³–æœä¿¡ç®±</span>
        </div>
        
        <div className="flex gap-2">
          <button 
            type="button"
            onClick={() => setShowShareHelp(true)}
            className="flex items-center gap-1 px-3 py-2 bg-white/80 rounded-full shadow-sm hover:bg-pink-50 text-pink-500 text-xs font-bold border border-pink-100 transition-transform active:scale-95"
          >
            <Share2 size={16} />
            <span>æ€ä¹ˆåˆ†äº«?</span>
          </button>

          <button 
            type="button"
            onClick={() => {
              setView(view === 'write' ? 'read' : 'write');
            }}
            className="p-2 bg-white/80 rounded-full shadow-sm hover:bg-pink-50 text-pink-400 border border-pink-100 transition-transform active:scale-95"
          >
            {view === 'write' ? <Lock size={20} /> : <Send size={20} />}
          </button>
        </div>
      </header>

      <main className="flex-1 w-full max-w-md p-4 z-10 flex flex-col justify-center items-center mb-10">
        
        {/* Success Notification */}
        {showSuccess && (
          <div className="fixed top-20 z-50 bg-green-100 border border-green-200 text-green-700 px-6 py-3 rounded-full shadow-lg flex items-center gap-2 animate-bounce">
            <Heart className="fill-green-500 text-green-500" size={18} />
            <span>æŠ•é€’æˆåŠŸï¼</span>
          </div>
        )}

        {/* VIEW: WRITE MESSAGE */}
        {view === 'write' && (
          <div className="w-full bg-white/90 backdrop-blur-md rounded-[2rem] shadow-xl border-4 border-pink-100 p-6 md:p-8 relative transition-all duration-300">
            <div className="absolute -top-5 left-1/2 transform -translate-x-1/2 bg-pink-400 text-white px-6 py-1 rounded-full text-sm font-bold shadow-md tracking-widest flex items-center gap-1">
              <Sparkles size={14} /> ç»™æˆ‘çš„ç•™è¨€
            </div>

            <div className="text-center mb-6 mt-2">
              <h1 className="text-2xl font-bold text-gray-700">å†™ä¸‹ä¸€å°ç”œç”œçš„ä¿¡</h1>
              <p className="text-gray-400 text-sm mt-1">è¿™é‡Œæ˜¯åŒ¿åæŠ•é€’å¤„å“¦</p>
            </div>

            <form onSubmit={handleSend} className="space-y-4">
              <div>
                <label className="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-1 ml-2">
                  ç½²å <span className="font-normal normal-case text-pink-300">(å¯é€‰)</span>
                </label>
                <input 
                  type="text" 
                  value={senderName}
                  onChange={(e) => setSenderName(e.target.value)}
                  placeholder="ç¥ç§˜äºº..."
                  className="w-full bg-pink-50 border-2 border-transparent focus:border-pink-300 rounded-2xl px-4 py-3 outline-none transition-all text-gray-600 placeholder-pink-200"
                  maxLength={20}
                />
              </div>

              <div>
                <label className="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-1 ml-2">
                  å†…å®¹ <span className="text-pink-500">*</span>
                </label>
                <textarea 
                  value={messageContent}
                  onChange={(e) => setMessageContent(e.target.value)}
                  placeholder="ä»Šå¤©å‘ç”Ÿäº†ä»€ä¹ˆå¼€å¿ƒçš„äº‹å—ï¼Ÿ"
                  className="w-full h-36 bg-pink-50 border-2 border-transparent focus:border-pink-300 rounded-2xl px-4 py-3 outline-none transition-all text-gray-600 placeholder-pink-200 resize-none leading-relaxed"
                  required
                />
              </div>

              <button 
                type="submit" 
                disabled={loading}
                className={`w-full py-4 rounded-2xl font-bold text-white shadow-lg transform transition-all active:scale-[0.98] flex justify-center items-center gap-2
                  ${loading ? 'bg-pink-300 cursor-wait' : 'bg-gradient-to-r from-pink-400 to-rose-400 hover:shadow-pink-200 hover:-translate-y-1'}
                `}
              >
                {loading ? 'æ­£åœ¨æŠ•é€’...' : (
                  <>
                    æŠ•é€’ä¿¡ä»¶ <Send size={18} />
                  </>
                )}
              </button>
            </form>
          </div>
        )}

        {/* VIEW: READ MESSAGES (LOCKED) */}
        {view === 'read' && !isUnlocked && (
          <div className="w-full bg-white/90 backdrop-blur-md rounded-[2rem] shadow-xl border-4 border-purple-100 p-8 text-center animate-in fade-in zoom-in duration-300">
            <div className="mb-6 flex justify-center text-purple-300">
              <Lock size={48} />
            </div>
            <h2 className="text-xl font-bold text-gray-700 mb-2">ä¿¡ç®±ä¸»äººä¸“åŒº</h2>
            <p className="text-gray-400 text-sm mb-6">è¯·è¾“å…¥æš—å·å¼€å¯ä¿¡ç®±</p>
            
            <form onSubmit={handleUnlock} className="flex flex-col gap-3">
              <input 
                type="password" 
                value={adminCode}
                onChange={(e) => setAdminCode(e.target.value)}
                className="w-full bg-purple-50 border-2 border-transparent focus:border-purple-300 rounded-2xl px-4 py-3 text-center text-lg outline-none tracking-widest text-purple-800 placeholder-purple-200"
                placeholder="è¾“å…¥æš—å·"
                inputMode="numeric"
              />
              <button 
                type="submit"
                className="w-full bg-purple-400 text-white font-bold py-3 rounded-2xl shadow-md hover:bg-purple-500 transition-all active:scale-95"
              >
                å¼€å¯ä¿¡ç®±
              </button>
            </form>
          </div>
        )}

        {/* VIEW: READ MESSAGES (UNLOCKED) */}
        {view === 'read' && isUnlocked && (
          <div className="w-full max-w-3xl animate-in slide-in-from-bottom-4 duration-500">
            <div className="flex justify-between items-center mb-6 px-2">
              <h2 className="text-xl font-bold text-gray-700 flex items-center gap-2">
                <Unlock size={20} className="text-pink-400" />
                æ”¶åˆ°çš„ä¿¡ä»¶ ({messages.length})
              </h2>
              <button 
                type="button"
                onClick={() => setIsUnlocked(false)} 
                className="text-xs text-gray-400 hover:text-pink-500 underline px-2 py-1"
              >
                é”å®šä¿¡ç®±
              </button>
            </div>

            {messages.length === 0 ? (
              <div className="text-center py-20 text-gray-400 bg-white/50 rounded-3xl border-2 border-dashed border-pink-200 backdrop-blur-sm">
                <Mail className="mx-auto mb-2 opacity-20" size={40} />
                <p>è¿˜æ²¡æœ‰æ”¶åˆ°ä¿¡ä»¶å“¦</p>
                <button 
                  onClick={() => setShowShareHelp(true)}
                  className="mt-4 text-pink-500 text-sm font-bold hover:underline"
                >
                  ç‚¹å‡»æŸ¥çœ‹å¦‚ä½•åˆ†äº«ç»™æœ‹å‹
                </button>
              </div>
            ) : (
              <div className="grid grid-cols-1 gap-4 pb-20">
                {messages.map((msg) => {
                  const cardThemes = [
                    "bg-pink-100 text-pink-800 border-pink-200",
                    "bg-amber-100 text-amber-800 border-amber-200",
                    "bg-blue-100 text-blue-800 border-blue-200",
                  ];
                  const themeClass = cardThemes[(msg.theme || 0) % cardThemes.length];
                  
                  const date = msg.timestamp 
                    ? new Date(msg.timestamp).toLocaleString('zh-CN', {
                        month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
                      }) 
                    : 'Unknown time';

                  return (
                    <div key={msg.id} className={`relative p-5 rounded-2xl shadow-sm border ${themeClass} transition-transform hover:scale-[1.01] animate-in fade-in zoom-in duration-300`}>
                      <div className="flex justify-between items-start mb-2 border-b border-black/5 pb-2">
                        <span className="font-bold text-sm flex items-center gap-1">
                           From: {msg.name}
                        </span>
                        <span className="text-xs opacity-60">{date}</span>
                      </div>
                      <p className="whitespace-pre-wrap leading-relaxed text-sm md:text-base break-words">
                        {msg.content}
                      </p>
                    </div>
                  );
                })}
              </div>
            )}
          </div>
        )}
      </main>

      {/* Footer */}
      <footer className="w-full text-center py-4 text-xs text-pink-300/80 z-10 pointer-events-none">
        Made with ğŸ’— by Sugar Mailbox
      </footer>
    </div>
  );
}

